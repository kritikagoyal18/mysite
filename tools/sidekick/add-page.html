<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Google Drive Folder Structure</title>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
  <h1>Google Drive Folder Structure</h1>
  <ul id="folder-structure"></ul>

  <script>
    const SCOPES = "https://www.googleapis.com/auth/drive.metadata.readonly";
    const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
    const contentUrl = 'https://drive.google.com/drive/folders/1I5OPtzRgSRdRE9qEG2sXeownbAkwUJbO'; // Example folder URL

    const folderStructure = document.getElementById("folder-structure");

    function getFolderIdFromUrl(url) {
      const match = url.match(/\/folders\/([a-zA-Z0-9-_]+)/);
      return match ? match[1] : null;
    }

    function handleClientLoad() {
      gapi.load("client:auth2", initClient);
    }

    function initClient() {
      gapi.client.init({
        discoveryDocs: DISCOVERY_DOCS,
        scope: SCOPES,
      }).then(() => {
        const authInstance = gapi.auth2.getAuthInstance();
        const isSignedIn = authInstance.isSignedIn.get();

        if (isSignedIn) {
          // Fetch folder contents if the user is already authenticated
          const folderId = getFolderIdFromUrl(contentUrl);
          if (folderId) {
            fetchFolderContents(folderId);
          } else {
            console.error("Invalid folder URL.");
          }
        } else {
          console.log("User is not signed in to Google.");
          // Attempt to fetch without explicit sign-in
          attemptFetchWithSession();
        }
      }).catch((error) => {
        console.error("Error initializing GAPI client:", error);
      });
    }

    function attemptFetchWithSession() {
      // Attempting to use an existing Google session to fetch data
      const folderId = getFolderIdFromUrl(contentUrl);
      if (!folderId) {
        console.error("Invalid folder URL.");
        return;
      }

      fetch(`https://www.googleapis.com/drive/v3/files?q='${folderId}'+in+parents+and+trashed=false&fields=files(id,name,mimeType)`, {
        credentials: "include", // Use credentials from the user's browser session
      }).then((response) => {
        if (!response.ok) {
          throw new Error(`Failed to fetch folder contents: ${response.statusText}`);
        }
        return response.json();
      }).then((data) => {
        const files = data.files;
        folderStructure.innerHTML = "";
        if (files && files.length > 0) {
          files.forEach((file) => {
            const li = document.createElement("li");
            li.textContent = `${file.name} (${file.mimeType === "application/vnd.google-apps.folder" ? "Folder" : "File"})`;
            folderStructure.appendChild(li);
          });
        } else {
          folderStructure.innerHTML = "<li>No files found in this folder.</li>";
        }
      }).catch((error) => {
        console.error("Error fetching folder contents:", error);
      });
    }

    function fetchFolderContents(folderId) {
      gapi.client.drive.files.list({
        q: `'${folderId}' in parents and trashed = false`,
        fields: "files(id, name, mimeType)",
      }).then((response) => {
        const files = response.result.files;
        folderStructure.innerHTML = "";
        if (files && files.length > 0) {
          files.forEach((file) => {
            const li = document.createElement("li");
            li.textContent = `${file.name} (${file.mimeType === "application/vnd.google-apps.folder" ? "Folder" : "File"})`;
            folderStructure.appendChild(li);
          });
        } else {
          folderStructure.innerHTML = "<li>No files found in this folder.</li>";
        }
      }).catch((error) => {
        console.error("Error fetching folder contents:", error);
      });
    }

    handleClientLoad();
  </script>
</body>
</html>